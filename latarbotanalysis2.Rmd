---
title: "LaTARBot Data"
author: "Jessica Nicosia"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: yes
    toc_depth: 6
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, collapse = TRUE, fig.show = 'hold')
rm(list = ls(all = TRUE))
```

```{r, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
library(readit)
library(lme4)
library(broom)
library(ggforce)
library(effsize)
library(pROC)
library(DT)
library(psych)
library(survminer)
library(survival)
library(data.table)
library(sjPlot)
library(ggpubr)
library(data.table)
library(gtsummary)
library(Rmisc)
library(pander)
library(ez)
library(directlabels)
library(tidyverse)
```

# Load Data
```{r}
setwd("~/CTRLab/LaTARBot/latarprocessing/")

##### CAPACITIVE
wd <- "./04-CSV_data/Capacitive_Tap_Latency/"
N <- paste(wd, list.files(wd), sep = "")
data <- data.frame()
for (i in 1:length(N)){
  file <- N[i]
  #print(file)
  data_in <- read.csv(file, header = TRUE, stringsAsFactors = FALSE)
  data_in$procedure <- str_match(basename(N[i]), "([0-9]{3})_ms")[,2]
  data <- rbind(data, data_in)
}

capacitivedata <- data


##### DISPLAY
wd <- "./04-CSV_data/Display_Latency/"
N <- paste(wd, list.files(wd), sep = "")
data <- data.frame()
for (i in 1:length(N)){
  file <- N[i]
  #print(file)
  data_in <- read.csv(file, header = TRUE, stringsAsFactors = FALSE)
  data_in$procedure <- str_match(basename(N[i]), "([0-9]{3})_ms")[,2]
  data <- rbind(data, data_in)
}

displaydata <- data



##### SOLENOID
wd <- "./04-CSV_data/Solenoid_Tap_Latency/"
N <- paste(wd, list.files(wd), sep = "")
data <- data.frame()
for (i in 1:length(N)){
  file <- N[i]
  #print(file)
  data_in <- read.csv(file, header = TRUE, stringsAsFactors = FALSE)
  data_in$procedure <- str_match(basename(N[i]), "([0-9]{3})_ms")[,2]
  data <- rbind(data, data_in)
}

solenoiddata <- data
```

# Clean Data
```{r}
capacitivedata1 <- capacitivedata %>%
  group_by(phone_model, load, procedure) %>%
  mutate(action_latency_us_mean = mean(action_latency_us, na.rm = T),
         action_latency_us_sd = mean(action_latency_us, na.rm = T),
         action_latency_us_z = (action_latency_us-action_latency_us_mean)/action_latency_us_sd,
         callback_latency_us_mean = mean(callback_latency_us, na.rm = T),
         callback_latency_us_sd = mean(callback_latency_us, na.rm = T),
         callback_latency_us_z = (callback_latency_us-callback_latency_us_mean)/callback_latency_us_sd,
         action_latency_us_otlrsrmvd = ifelse(abs(action_latency_us_z) > 3, NA, action_latency_us),
         callback_latency_us_otlrsrmvd = ifelse(abs(callback_latency_us_z) > 3, NA, callback_latency_us))

displaydata1 <- displaydata %>%
  group_by(phone_model, load, procedure) %>%
  mutate(display_latency_us_mean = mean(display_latency_us, na.rm = T),
         display_latency_us_sd = mean(display_latency_us, na.rm = T),
         display_latency_us_z = (display_latency_us-display_latency_us_mean)/display_latency_us_sd,
         display_latency_us_otlrsrmvd = ifelse(abs(display_latency_us_z) > 3, NA, display_latency_us))
```

## Line Graphs
```{r}
# capacitive
# raw
capacitivedata1_noload <- subset(capacitivedata1, load == "none")

ggplot(capacitivedata1_noload, aes(x = index_fixture, y = action_latency_us_otlrsrmvd, color = phone_model)) +
  labs(title = "Raw Capacitive") +
  geom_line(aes(color = phone_model, linetype = procedure)) +
  geom_point(aes(color = phone_model, shape = procedure)) + 
  facet_wrap(~procedure) +
  theme_classic() +
  theme(strip.background = element_blank())
#+ coord_cartesian(ylim = c(0, 80000))

# display
# raw
displaydata1_noload <- subset(displaydata1, load == "none")

ggplot(displaydata1_noload, aes(x = index_fixture, y = display_latency_us_otlrsrmvd, color = phone_model)) +
  labs(title = "Raw Display") +
 geom_line(aes(color = phone_model, linetype = procedure)) +
  geom_point(aes(color = phone_model, shape = procedure)) + 
  facet_wrap(~procedure) +
  theme_classic() +
  theme(strip.background = element_blank())
```

## Bar Graphs
### By Phone
```{r}
# means
capacitivemeans <- summarySE(data = capacitivedata1_noload,
                             measurevar = "action_latency_us_otlrsrmvd",
                             groupvars = c("phone_model", "procedure"),
                             na.rm = T,
                             conf.interval = 0.95,
                             .drop = TRUE)

# plot
ggplot(capacitivemeans, aes(x = procedure,
                            y = action_latency_us_otlrsrmvd, 
                            fill = procedure)) +
geom_bar(position = "dodge",
         stat = "identity",
         color = "black") +
  scale_fill_manual(values = c("white", "grey70", "grey50")) +
  labs(x = "Load",
       y = "RT (us)") +
  guides(fill = guide_legend(title = "Procedure")) +
  geom_errorbar(aes (ymin = action_latency_us_otlrsrmvd - ci, ymax = action_latency_us_otlrsrmvd + ci),
                position = position_dodge(0.9), width = .1) +
  #coord_cartesian(ylim = c(-0.25, 0.15)) +
  facet_wrap(~phone_model, scales = "free_x", ncol = 6) +
  theme_classic() +
  theme(text = element_text(size = 9), 
        strip.background = element_blank())  + 
  theme(text = element_text(size = 9)) 

# means
displaymeans <- summarySE(data = displaydata1_noload,
                             measurevar = "display_latency_us_otlrsrmvd",
                             groupvars = c("phone_model", "procedure"),
                             na.rm = T,
                             conf.interval = 0.95,
                             .drop = TRUE)

# plot
ggplot(displaymeans, aes(x = procedure,
                         y = display_latency_us_otlrsrmvd, 
                         fill = procedure)) +
geom_bar(position = "dodge",
         stat = "identity",
         color = "black") +
  scale_fill_manual(values = c("white", "grey70", "grey50")) +
  labs(x = "Load",
       y = "RT (us)") +
  guides(fill = guide_legend(title = "Procedure")) +
  geom_errorbar(aes (ymin = display_latency_us_otlrsrmvd - ci, ymax = display_latency_us_otlrsrmvd + ci),
                position = position_dodge(0.9), width = .1) +
  #coord_cartesian(ylim = c(-0.25, 0.15)) +
  facet_wrap(~phone_model, scales = "free_x", ncol = 6) +
  theme_classic() +
  theme(text = element_text(size = 9), 
        strip.background = element_blank())  + 
  theme(text = element_text(size = 9)) 
```

### Across Phones
```{r}
# means
capacitivemeans <- summarySE(data = capacitivedata1_noload,
                             measurevar = "action_latency_us_otlrsrmvd",
                             groupvars = c("procedure"),
                             na.rm = T,
                             conf.interval = 0.95,
                             .drop = TRUE)

# plot
ggplot(capacitivemeans, aes(x = procedure,
                            y = action_latency_us_otlrsrmvd, 
                            fill = procedure)) +
geom_bar(position = "dodge",
         stat = "identity",
         color = "black") +
  scale_fill_manual(values = c("white", "grey70", "grey50")) +
  labs(x = "Load",
       y = "RT (us)") +
  guides(fill = guide_legend(title = "Procedure")) +
  geom_errorbar(aes (ymin = action_latency_us_otlrsrmvd - ci, ymax = action_latency_us_otlrsrmvd + ci),
                position = position_dodge(0.9), width = .1) +
  #coord_cartesian(ylim = c(-0.25, 0.15)) +
  #facet_wrap(~phone_model, scales = "free_x", ncol = 6) +
  theme_classic() +
  theme(text = element_text(size = 9), 
        strip.background = element_blank())  + 
  theme(text = element_text(size = 9))

# means
displaymeans <- summarySE(data = displaydata1_noload,
                             measurevar = "display_latency_us_otlrsrmvd",
                             groupvars = c("procedure"),
                             na.rm = T,
                             conf.interval = 0.95,
                             .drop = TRUE)

# plot
ggplot(displaymeans, aes(x = procedure,
                            y = display_latency_us_otlrsrmvd, 
                            fill = procedure)) +
geom_bar(position = "dodge",
         stat = "identity",
         color = "black") +
  scale_fill_manual(values = c("white", "grey70", "grey50")) +
  labs(x = "Load",
       y = "RT (us)") +
  guides(fill = guide_legend(title = "Procedure")) +
  geom_errorbar(aes (ymin = display_latency_us_otlrsrmvd - ci, ymax = display_latency_us_otlrsrmvd + ci),
                position = position_dodge(0.9), width = .1) +
  #coord_cartesian(ylim = c(-0.25, 0.15)) +
  #facet_wrap(~phone_model, scales = "free_x", ncol = 6) +
  theme_classic() +
  theme(text = element_text(size = 9), 
        strip.background = element_blank())  + 
  theme(text = element_text(size = 9))
```

# Regressions
## What matters?
```{r}
phonedata <- read.csv("~/CTRLab/LaTARBot/latarprocessing/phone_data.csv")
capacitivedatafull <- full_join(capacitivedata1_noload, phonedata)

summary(lmer(action_latency_us_otlrsrmvd ~ Geekbench_5_single_core + Touch_refresh_Hz + (index_fixture|phone_model), data = capacitivedatafull))

summary(lmer(callback_latency_us_otlrsrmvd ~ Geekbench_5_single_core + Touch_refresh_Hz + (index_fixture|phone_model), data = capacitivedatafull))
```





